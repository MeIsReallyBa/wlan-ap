From cd8ccba4164608ec55216c3e879022bd0048387c Mon Sep 17 00:00:00 2001
From: John Crispin <john@phrozen.org>
Date: Tue, 4 Oct 2022 15:37:51 +0200
Subject: [PATCH 12/13] ipq40xx: add missing ecw5211 features

Signed-off-by: John Crispin <john@phrozen.org>
---
 .../ipq40xx/base-files/etc/board.d/01_leds    |  1 +
 .../etc/hotplug.d/firmware/11-ath10k-caldata  |  2 ++
 .../ipq40xx/base-files/etc/init.d/bootcount   | 13 ++++++++++++-
 .../base-files/lib/upgrade/platform.sh        | 19 ++++++++++++++++++-
 .../arm/boot/dts/qcom-ipq4018-ecw5211.dts     | 10 ++++++++++
 5 files changed, 43 insertions(+), 2 deletions(-)

diff --git a/target/linux/ipq40xx/base-files/etc/board.d/01_leds b/target/linux/ipq40xx/base-files/etc/board.d/01_leds
index 7910a320c7..fdceb85158 100644
--- a/target/linux/ipq40xx/base-files/etc/board.d/01_leds
+++ b/target/linux/ipq40xx/base-files/etc/board.d/01_leds
@@ -94,6 +94,7 @@ qxwlan,e2600ac-c2)
 	ucidef_set_led_wlan "wlan2g" "WLAN0" "green:wlan0" "phy0tpt"
 	ucidef_set_led_wlan "wlan5g" "WLAN1" "green:wlan1" "phy1tpt"
 	;;
+edgecore,ecw5211|\
 zyxel,nbg6617 |\
 zyxel,wre6606)
 	ucidef_set_led_wlan "wlan2g" "WLAN2G" "green:wlan2g" "phy0tpt"
diff --git a/target/linux/ipq40xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata b/target/linux/ipq40xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata
index 7c4267e1bc..a5dd7e8622 100644
--- a/target/linux/ipq40xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata
+++ b/target/linux/ipq40xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata
@@ -78,6 +78,7 @@ case "$FIRMWARE" in
 		/usr/bin/fritz_cal_extract -i 1 -s 0x3D000 -e 0x207 -l 12064 -o /lib/firmware/$FIRMWARE $(find_mtd_chardev "urlader1")
 		;;
 	cellc,rtl30vw |\
+	edgecore,ecw5211 |\
 	openmesh,a42 |\
 	openmesh,a62 |\
 	plasmacloud,pa1200 |\
@@ -173,6 +174,7 @@ case "$FIRMWARE" in
 		/usr/bin/fritz_cal_extract -i 1 -s 0x3C000 -e 0x208 -l 12064 -o /lib/firmware/$FIRMWARE $(find_mtd_chardev "urlader1")
 		;;
 	cellc,rtl30vw |\
+	edgecore,ecw5211 |\
 	openmesh,a42 |\
 	openmesh,a62 |\
 	plasmacloud,pa1200 |\
diff --git a/target/linux/ipq40xx/base-files/etc/init.d/bootcount b/target/linux/ipq40xx/base-files/etc/init.d/bootcount
index 9abfbddc43..63b4e67930 100755
--- a/target/linux/ipq40xx/base-files/etc/init.d/bootcount
+++ b/target/linux/ipq40xx/base-files/etc/init.d/bootcount
@@ -8,7 +8,18 @@ boot() {
 		[ -n "$(fw_printenv bootcount changed 2>/dev/null)" ] &&\
 			echo -e "bootcount\nchanged\n" | /usr/sbin/fw_setenv -s -
 		;;
-	linksys,ea6350v3|\
+	edgecore,ecw5211)
+		part="$(awk -F 'ubi.mtd=' '{printf $2}' /proc/cmdline | cut -d " " -f1)"
+		case "$part" in
+		rootfs1|\
+		rootfs2)
+			avail=$(fw_printenv -n upgrade_available)
+			[ ${avail} -ne 1 ] && fw_setenv upgrade_available 1
+			fw_setenv bootcount 0
+			;;
+		esac
+		;;
+linksys,ea6350v3|\
 	linksys,ea8300|\
 	linksys,mr8300)
 		mtd resetbc s_env || true
diff --git a/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh b/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh
index 95af708a77..1faafae192 100644
--- a/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh
+++ b/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh
@@ -107,7 +107,6 @@ platform_do_upgrade() {
 	avm,fritzrepeater-3000 |\
 	buffalo,wtr-m2133hp |\
 	cilab,meshpoint-one |\
-	edgecore,ecw5211 |\
 	edgecore,oap100 |\
 	engenius,eap2200 |\
 	glinet,gl-ap1300 |\
@@ -121,6 +120,24 @@ platform_do_upgrade() {
 	wallys,dr40x9)
 		nand_do_upgrade "$1"
 		;;
+	edgecore,ecw5211)
+		mkdir -p /var/lock/
+		part="$(awk -F 'ubi.mtd=' '{printf $2}' /proc/cmdline | cut -d " " -f 1)"
+		case "$part" in
+		rootfs1)
+			fw_setenv active 2 || exit 1
+			CI_UBIPART="rootfs2"
+			;;
+		rootfs2)
+			fw_setenv active 1 || exit 1
+			CI_UBIPART="rootfs1"
+			;;
+		*)
+			# legacy bootloader
+			;;
+		esac
+		nand_do_upgrade "$1"
+		;;
 	glinet,gl-b2200)
 		CI_KERNPART="0:HLOS"
 		CI_ROOTPART="rootfs"
diff --git a/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-ecw5211.dts b/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-ecw5211.dts
index 6f4d7b5f32..ed014c4a23 100644
--- a/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-ecw5211.dts
+++ b/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-ecw5211.dts
@@ -269,6 +269,16 @@
 				label = "rootfs";
 				reg = <0x00000000 0x04000000>;
 			};
+
+			partition@1 {
+				label = "rootfs1";
+				reg = <0x00000000 0x04000000>;
+			};
+
+			partition@4000000 {
+				label = "rootfs2";
+				reg = <0x04000000 0x04000000>;
+			};
 		};
 	};
 };
-- 
2.25.1

